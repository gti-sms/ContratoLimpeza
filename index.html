<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Completo - Materiais de Limpeza SMS</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    
    <style>
        :root {
            --primary: #1a5276;
            --primary-dark: #13405c;
            --primary-light: #2e86c1;
            --secondary: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --success-light: #d4edda;
            --success-dark: #155724;
            --info-light: #cce7ff;
            --info-dark: #004085;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            min-height: 100vh;
            color: var(--dark);
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo {
            font-size: 2.5rem;
        }
        
        .header-text h1 {
            font-size: 1.8rem;
            margin-bottom: 0.25rem;
        }
        
        .dashboard {
            background: white;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .tabs {
            display: flex;
            background: var(--light);
            border-bottom: 1px solid var(--light-gray);
            overflow-x: auto;
        }
        
        .tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            background: white;
        }
        
        .tab-content {
            display: none;
            padding: 2rem;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 4px solid var(--primary);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-card h3 {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .chart-container {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            height: 300px;
            transition: transform 0.3s ease;
        }
        
        .chart-container:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .table-container {
            margin-top: 2rem;
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--light-gray);
        }
        
        th {
            background: var(--primary);
            color: white;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background: rgba(26, 82, 118, 0.05);
        }
        
        .status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .ok { background: var(--success-light); color: var(--success-dark); }
        .warning { background: #fff3cd; color: #856404; }
        .danger { background: #f8d7da; color: #721c24; }
        
        .controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }
        
        select, button, input {
            padding: 0.7rem 1rem;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        select, input {
            background: white;
            min-width: 200px;
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.3s ease;
        }
        
        button:hover {
            background: var(--primary-dark);
        }
        
        .unit-details {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }
        
        .units-list {
            background: var(--light);
            border-radius: 8px;
            padding: 1.5rem;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .unit-item {
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary);
        }
        
        .unit-item:hover {
            background: #e9ecef;
        }
        
        .unit-item.active {
            background: var(--primary-light);
            color: white;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .product-card {
            background: white;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }
        
        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .product-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .product-name {
            font-weight: bold;
            color: var(--primary);
        }
        
        .product-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .data-item {
            margin-bottom: 0.5rem;
        }
        
        .data-label {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        .data-value {
            font-weight: bold;
        }
        
        .suggestions {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--light-gray);
        }
        
        .suggestion-item {
            background: #e7f3ff;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        .ai-insights {
            background: #f0f8ff;
            border-left: 4px solid var(--primary);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 2rem;
        }
        
        .insight-item {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #d1e7ff;
        }
        
        .insight-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }
        
        footer {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
            margin-top: 2rem;
        }
        
        .unit-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }
        
        .type-ubs { background: var(--success-light); color: var(--success-dark); }
        .type-cais { background: var(--info-light); color: var(--info-dark); }
        .type-demais { background: #f8d7da; color: #721c24; }
        
        .efficiency-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .efficiency-stat-card {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }
        
        .efficiency-stat-card:hover {
            transform: translateY(-5px);
        }
        
        .efficiency-stat-card.efficient {
            border-left: 4px solid var(--secondary);
        }
        
        .efficiency-stat-card.attention {
            border-left: 4px solid var(--warning);
        }
        
        .efficiency-stat-card.critical {
            border-left: 4px solid var(--danger);
        }
        
        .efficiency-stat-card h3 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .efficiency-stat-card.efficient h3 {
            color: var(--secondary);
        }
        
        .efficiency-stat-card.attention h3 {
            color: var(--warning);
        }
        
        .efficiency-stat-card.critical h3 {
            color: var(--danger);
        }
        
        .efficiency-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .efficiency-high { background: var(--success-light); color: var(--success-dark); }
        .efficiency-medium { background: #fff3cd; color: #856404; }
        .efficiency-low { background: #f8d7da; color: #721c24; }
        
        .product-detail-panel {
            display: none;
            background: white;
            border-radius: 8px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
        }
        
        .product-detail-panel.active {
            display: block;
        }
        
        .product-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .product-detail-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .product-detail-stat {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .product-detail-stat:hover {
            transform: translateY(-3px);
        }
        
        .product-detail-stat h3 {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .units-distribution {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
        }
        
        .unit-distribution-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: var(--light);
            border-radius: 6px;
            border-left: 4px solid var(--primary);
            transition: background 0.3s ease;
        }
        
        .unit-distribution-item:hover {
            background: #e9ecef;
        }
        
        .unit-distribution-info {
            flex: 1;
        }
        
        .unit-distribution-stock {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .stock-bar {
            width: 100px;
            height: 8px;
            background: var(--light-gray);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .stock-fill {
            height: 100%;
            border-radius: 4px;
        }
        
        .stock-fill.ok { background: var(--secondary); }
        .stock-fill.warning { background: var(--warning); }
        .stock-fill.danger { background: var(--danger); }
        
        .clickable-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .clickable-row:hover {
            background-color: rgba(26, 82, 118, 0.1) !important;
        }
        
        .export-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            border-left: 4px solid var(--primary);
        }
        
        .export-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }
        
        .export-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            transition: background 0.3s ease, transform 0.2s ease;
        }
        
        .export-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .export-btn.warning {
            background: var(--warning);
            color: var(--dark);
        }
        
        .export-btn.warning:hover {
            background: #e0a800;
        }
        
        .export-btn.danger {
            background: var(--danger);
        }
        
        .export-btn.danger:hover {
            background: #c82333;
        }
        
        .suggestion-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        .suggestion-card {
            background: white;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .respondent-info {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--light-gray);
        }
        
        .respondent-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .respondent-details {
            flex: 1;
        }
        
        .respondent-name {
            font-weight: bold;
            margin-bottom: 0.25rem;
        }
        
        .respondent-role {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        .suggestion-date {
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        .supplier-issues {
            background: #fff3cd;
            border-left: 4px solid var(--warning);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 2rem;
        }
        
        .issue-item {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #ffeaa7;
        }
        
        .issue-item:last-child {
            margin-bottom: 0;
            border-bottom: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .admin-panel {
            display: none;
            background: white;
            border-radius: 8px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .admin-login {
            max-width: 400px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .admin-login h2 {
            text-align: center;
            margin-bottom: 1.5rem;
            color: var(--primary);
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 0.7rem 1rem;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .admin-tabs {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .admin-tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .admin-tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
        }
        
        .admin-tab-content {
            display: none;
        }
        
        .admin-tab-content.active {
            display: block;
        }
        
        .upload-area {
            border: 2px dashed var(--light-gray);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: var(--primary);
            background: rgba(26, 82, 118, 0.05);
        }
        
        .upload-area i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .csv-preview {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1.5rem;
        }
        
        .admin-logout {
            text-align: right;
            margin-bottom: 1rem;
        }
        
        .month-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: center;
        }
        
        .month-selector label {
            font-weight: 500;
        }
        
        .unit-manager {
            margin-top: 2rem;
        }
        
        .unit-manager-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .units-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        
        .unit-manager-card {
            background: white;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }
        
        .unit-manager-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }
        
        .unit-manager-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .unit-manager-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .unit-manager-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }
        
        .suggestions-container {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .suggestion-full-item {
            background: #f8f9fa;
            border-left: 4px solid var(--primary);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            transition: background 0.3s ease;
        }
        
        .suggestion-full-item:hover {
            background: #e9ecef;
        }
        
        .suggestion-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
            color: var(--gray);
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: var(--light-gray);
        }
        
        .suggestion-form {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .suggestion-form textarea {
            width: 100%;
            padding: 1rem;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 100px;
        }
        
        .suggestion-form button {
            margin-top: 1rem;
        }
        
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .stats, .efficiency-stats, .product-detail-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .unit-details, .suggestion-details {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .stats, .efficiency-stats, .product-detail-stats {
                grid-template-columns: 1fr;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                flex: 1;
                min-width: 120px;
                text-align: center;
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .month-selector {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <p>Carregando dados...</p>
    </div>

    <div class="container" id="main-content">
        <header>
            <div class="header-content">
                <div class="logo-container">
                    <i class="fas fa-hand-holding-medical logo"></i>
                    <div class="header-text">
                        <h1>Painel Completo - Materiais de Limpeza</h1>
                        <p>Secretaria Municipal de Sa√∫de - Vis√£o Consolidada de Todas as Unidades</p>
                    </div>
                </div>
                <div class="header-stats">
                    <div style="text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: bold;" id="totalUnits">0</div>
                        <div style="font-size: 0.8rem;">Unidades Monitoradas</div>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="dashboard">
            <div class="tabs">
                <div class="tab active" data-tab="overview">Vis√£o Geral</div>
                <div class="tab" data-tab="efficiency">Efici√™ncia de Estoque</div>
                <div class="tab" data-tab="units">Unidades</div>
                <div class="tab" data-tab="products">Produtos</div>
                <div class="tab" data-tab="suggestions">Sugest√µes</div>
                <div class="tab" data-tab="analysis">An√°lise IA</div>
                <div class="tab" data-tab="admin">Administra√ß√£o</div>
                <div class="tab admin-only" data-tab="manage-units" style="display: none;">Gerenciar Unidades</div>
            </div>
            
            <div class="tab-content active" id="overview">
                <div class="export-section">
                    <h3><i class="fas fa-file-export"></i> Exportar Relat√≥rios</h3>
                    <p>Gere relat√≥rios em PDF para documenta√ß√£o oficial e auditoria</p>
                    <div class="export-buttons">
                        <button class="export-btn" id="exportOverview">
                            <i class="fas fa-file-pdf"></i> Exportar Vis√£o Geral
                        </button>
                        <button class="export-btn warning" id="exportCritical">
                            <i class="fas fa-exclamation-triangle"></i> Exportar Situa√ß√£o Cr√≠tica
                        </button>
                        <button class="export-btn danger" id="exportSupplierIssues">
                            <i class="fas fa-truck-loading"></i> Exportar Problemas com Fornecedor
                        </button>
                    </div>
                </div>
                
                <div class="controls">
                    <select id="filterType">
                        <option value="all">Todos os Tipos</option>
                        <option value="UBS">UBS</option>
                        <option value="CAIS">CAIS</option>
                        <option value="DEMAIS">Demais</option>
                    </select>
                    <select id="monthFilterOverview">
                        <!-- Op√ß√µes de m√™s ser√£o preenchidas via JavaScript -->
                    </select>
                    <button id="refreshData">
                        <i class="fas fa-sync-alt"></i> Atualizar Dados
                    </button>
                </div>
                
                <div id="overviewEmptyState" class="empty-state">
                    <i class="fas fa-database"></i>
                    <h3>Nenhum dado dispon√≠vel</h3>
                    <p>Fa√ßa upload de arquivos CSV na aba Administra√ß√£o para visualizar os dados.</p>
                </div>
                
                <div id="overviewContent" style="display: none;">
                    <div class="stats">
                        <div class="stat-card">
                            <h3 id="totalUnitsCount">0</h3>
                            <p>Unidades de Sa√∫de</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="totalProductsCount">0</h3>
                            <p>Tipos de Produtos</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="criticalAlerts">0</h3>
                            <p>Alertas Cr√≠ticos</p>
                        </div>
                        <div class="stat-card">
                            <h3 id="suggestionsCount">0</h3>
                            <p>Sugest√µes Recebidas</p>
                        </div>
                    </div>
                    
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h3>Status do Estoque por Unidade</h3>
                            <canvas id="statusChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Produtos Mais Faltantes</h3>
                            <canvas id="productsChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Distribui√ß√£o por Tipo de Unidade</h3>
                            <canvas id="typeChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Evolu√ß√£o de Alertas (√öltimos 6 Meses)</h3>
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <h3>Unidades com Mais Solicita√ß√µes</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Unidade</th>
                                    <th>Tipo</th>
                                    <th>Produtos Cr√≠ticos</th>
                                    <th>Produtos em Aten√ß√£o</th>
                                    <th>Sugest√µes</th>
                                    <th>Status Geral</th>
                                    <th>√öltima Atualiza√ß√£o</th>
                                </tr>
                            </thead>
                            <tbody id="summaryTableBody">
                                <!-- Dados preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="efficiency">
                <h2><i class="fas fa-chart-line"></i> Efici√™ncia de Estoque por Unidade</h2>
                <p class="data-label" style="margin-bottom: 1.5rem;">An√°lise da adequa√ß√£o entre materiais disponibilizados e necessidades m√≠nimas sugeridas</p>
                
                <div class="month-selector">
                    <label for="monthFilterEfficiency">M√™s de refer√™ncia:</label>
                    <select id="monthFilterEfficiency">
                        <!-- Op√ß√µes de m√™s ser√£o preenchidas via JavaScript -->
                    </select>
                </div>
                
                <div id="efficiencyEmptyState" class="empty-state">
                    <i class="fas fa-chart-line"></i>
                    <h3>Nenhum dado dispon√≠vel</h3>
                    <p>Fa√ßa upload de arquivos CSV na aba Administra√ß√£o para visualizar os dados de efici√™ncia.</p>
                </div>
                
                <div id="efficiencyContent" style="display: none;">
                    <div class="efficiency-stats">
                        <div class="efficiency-stat-card efficient">
                            <h3 id="efficientUnits">0</h3>
                            <p>Unidades Eficientes</p>
                            <small>Efici√™ncia ‚â• 90%</small>
                        </div>
                        <div class="efficiency-stat-card attention">
                            <h3 id="attentionUnits">0</h3>
                            <p>Unidades em Aten√ß√£o</p>
                            <small>Efici√™ncia 70-89%</small>
                        </div>
                        <div class="efficiency-stat-card critical">
                            <h3 id="criticalUnits">0</h3>
                            <p>Unidades Cr√≠ticas</p>
                            <small>Efici√™ncia < 70%</small>
                        </div>
                    </div>
                    
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h3>Distribui√ß√£o da Efici√™ncia</h3>
                            <canvas id="efficiencyDistributionChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Unidades Mais Eficientes</h3>
                            <canvas id="topEfficiencyChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Unidades Menos Eficientes</h3>
                            <canvas id="bottomEfficiencyChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Efici√™ncia M√©dia por Tipo de Unidade</h3>
                            <canvas id="efficiencyByTypeChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <h3>Ranking de Efici√™ncia por Unidade</h3>
                        <table class="ranking-table">
                            <thead>
                                <tr>
                                    <th>Posi√ß√£o</th>
                                    <th>Unidade</th>
                                    <th>Tipo</th>
                                    <th>Efici√™ncia</th>
                                    <th>Status</th>
                                    <th>Produtos Analisados</th>
                                </tr>
                            </thead>
                            <tbody id="efficiencyTableBody">
                                <!-- Dados preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="units">
                <div class="unit-details">
                    <div class="units-list">
                        <h3>Lista de Unidades</h3>
                        <div class="month-selector">
                            <label for="monthFilterUnits">M√™s de refer√™ncia:</label>
                            <select id="monthFilterUnits">
                                <!-- Op√ß√µes de m√™s ser√£o preenchidas via JavaScript -->
                            </select>
                        </div>
                        <div id="unitsEmptyState" class="empty-state">
                            <i class="fas fa-hospital"></i>
                            <h3>Nenhuma unidade cadastrada</h3>
                            <p>Fa√ßa upload de arquivos CSV na aba Administra√ß√£o para adicionar unidades.</p>
                        </div>
                        <div id="unitsListContainer" style="display: none;">
                            <!-- Lista de unidades preenchida via JavaScript -->
                        </div>
                    </div>
                    
                    <div class="unit-details-content">
                        <h3 id="selectedUnitName">Selecione uma unidade para ver detalhes</h3>
                        <div id="unitProductsGrid" class="product-grid">
                            <!-- Produtos da unidade selecionada -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="products">
                <div class="controls">
                    <select id="filterProduct">
                        <option value="all">Todos os Produtos</option>
                        <!-- Op√ß√µes preenchidas via JavaScript -->
                    </select>
                    <select id="monthFilterProducts">
                        <!-- Op√ß√µes de m√™s ser√£o preenchidas via JavaScript -->
                    </select>
                    <button id="refreshProducts">
                        <i class="fas fa-sync-alt"></i> Atualizar Dados
                    </button>
                </div>
                
                <div id="productsEmptyState" class="empty-state">
                    <i class="fas fa-boxes"></i>
                    <h3>Nenhum produto cadastrado</h3>
                    <p>Fa√ßa upload de arquivos CSV na aba Administra√ß√£o para visualizar os produtos.</p>
                </div>
                
                <div id="productsContent" style="display: none;">
                    <div class="table-container">
                        <h3>Detalhamento por Produto</h3>
                        <table>
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Total Dispon√≠vel</th>
                                    <th>Total M√≠nimo Sugerido</th>
                                    <th>Unidades com Estoque Baixo</th>
                                    <th>Unidades com Estoque Cr√≠tico</th>
                                    <th>Status Geral</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Dados preenchidos via JavaScript -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="product-detail-panel" id="productDetailPanel">
                        <div class="product-detail-header">
                            <h2 id="selectedProductName">Detalhes do Produto</h2>
                            <button class="export-btn" id="exportProductDetail">
                                <i class="fas fa-file-pdf"></i> Exportar Detalhes
                            </button>
                        </div>
                        
                        <div class="product-detail-stats">
                            <div class="product-detail-stat">
                                <h3 id="detailTotalStock">0</h3>
                                <p>Total em Estoque</p>
                            </div>
                            <div class="product-detail-stat">
                                <h3 id="detailTotalMin">0</h3>
                                <p>M√≠nimo Sugerido</p>
                            </div>
                            <div class="product-detail-stat">
                                <h3 id="detailLowStock">0</h3>
                                <p>Unidades com Baixo Estoque</p>
                            </div>
                            <div class="product-detail-stat">
                                <h3 id="detailCriticalStock">0</h3>
                                <p>Unidades Cr√≠ticas</p>
                            </div>
                        </div>
                        
                        <div class="charts-grid">
                            <div class="chart-container">
                                <h3>Distribui√ß√£o por Unidade</h3>
                                <canvas id="productDistributionChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h3>Status do Estoque</h3>
                                <canvas id="productStatusChart"></canvas>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <h3>Distribui√ß√£o por Unidade</h3>
                            <div class="units-distribution" id="unitsDistribution">
                                <!-- Lista de unidades preenchida via JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="suggestions">
                <h2><i class="fas fa-comments"></i> Sugest√µes das Unidades</h2>
                <p class="data-label" style="margin-bottom: 1.5rem;">Sugest√µes enviadas pelas unidades com detalhes dos respondentes</p>
                
                <div class="month-selector">
                    <label for="monthFilterSuggestions">M√™s de refer√™ncia:</label>
                    <select id="monthFilterSuggestions">
                        <!-- Op√ß√µes de m√™s ser√£o preenchidas via JavaScript -->
                    </select>
                </div>
                
                <div class="suggestion-form">
                    <h3><i class="fas fa-lightbulb"></i> Sugest√£o de Produto N√£o Disponibilizado e Necess√°rio</h3>
                    <p>Utilize este espa√ßo para sugerir produtos que n√£o est√£o dispon√≠veis mas que s√£o necess√°rios para a sua unidade:</p>
                    <textarea id="newSuggestion" placeholder="Descreva aqui sua sugest√£o de produto n√£o disponibilizado e necess√°rio..."></textarea>
                    <button id="submitSuggestion" class="export-btn">
                        <i class="fas fa-paper-plane"></i> Enviar Sugest√£o
                    </button>
                </div>
                
                <div id="suggestionsEmptyState" class="empty-state">
                    <i class="fas fa-comments"></i>
                    <h3>Nenhuma sugest√£o dispon√≠vel</h3>
                    <p>Fa√ßa upload de arquivos CSV na aba Administra√ß√£o para visualizar as sugest√µes.</p>
                </div>
                
                <div id="suggestionsContent" style="display: none;">
                    <div class="suggestion-details">
                        <div class="suggestion-card">
                            <h3>√öltimas Sugest√µes Recebidas</h3>
                            <div class="suggestions-container" id="suggestionsList">
                                <!-- Lista de sugest√µes preenchida via JavaScript -->
                            </div>
                        </div>
                        
                        <div class="suggestion-card">
                            <h3>Detalhes do Respondente</h3>
                            <div id="respondentDetails">
                                <!-- Detalhes do respondente preenchidos via JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="supplier-issues">
                        <h3><i class="fas fa-exclamation-triangle"></i> Problemas Identificados com Fornecedor</h3>
                        <div id="supplierIssuesList">
                            <!-- Lista de problemas com fornecedor preenchida via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="analysis">
                <h2>An√°lises e Insights por IA</h2>
                
                <div class="month-selector">
                    <label for="monthFilterAnalysis">M√™s de refer√™ncia:</label>
                    <select id="monthFilterAnalysis">
                        <!-- Op√ß√µes de m√™s ser√£o preenchidas via JavaScript -->
                    </select>
                </div>
                
                <div id="analysisEmptyState" class="empty-state">
                    <i class="fas fa-robot"></i>
                    <h3>Nenhum dado para an√°lise</h3>
                    <p>Fa√ßa upload de arquivos CSV na aba Administra√ß√£o para gerar insights.</p>
                </div>
                
                <div id="analysisContent" style="display: none;">
                    <div class="ai-insights">
                        <h3><i class="fas fa-robot"></i> Insights Inteligentes</h3>
                        
                        <div class="insight-item">
                            <h4>üìä Padr√µes de Consumo Identificados</h4>
                            <p id="consumptionPatterns">Carregando an√°lise...</p>
                        </div>
                        
                        <div class="insight-item">
                            <h4>üö® Alertas Priorit√°rios</h4>
                            <p id="priorityAlerts">Carregando an√°lise...</p>
                        </div>
                    
                        <div class="insight-item">
                            <h4>üí° Sugest√µes Consolidadas</h4>
                            <p id="consolidatedSuggestions">Carregando an√°lise...</p>
                        </div>
                    
                        <div class="insight-item">
                            <h4>üìà Tend√™ncias e Previs√µes</h4>
                            <p id="trendsPredictions">Carregando an√°lise...</p>
                        </div>
                    
                        <div class="insight-item">
                            <h4>üí∞ Otimiza√ß√£o de Recursos</h4>
                            <p id="resourceOptimization">Carregando an√°lise...</p>
                        </div>
                    </div>
                    
                    <div class="charts-grid" style="margin-top: 2rem;">
                        <div class="chart-container">
                            <h3>Efici√™ncia de Estoque por Tipo</h3>
                            <canvas id="efficiencyChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3>Correla√ß√£o entre Produtos</h3>
                            <canvas id="correlationChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- √ÅREA ADMINISTRATIVA -->
            <div class="tab-content" id="admin">
                <div id="adminLogin" class="admin-login">
                    <h2><i class="fas fa-lock"></i> Acesso Administrativo</h2>
                    <div class="form-group">
                        <label for="adminUsername">Usu√°rio</label>
                        <input type="text" id="adminUsername" placeholder="Digite seu usu√°rio">
                    </div>
                    <div class="form-group">
                        <label for="adminPassword">Senha</label>
                        <input type="password" id="adminPassword" placeholder="Digite sua senha">
                    </div>
                    <button id="adminLoginBtn" class="export-btn" style="width: 100%;">
                        <i class="fas fa-sign-in-alt"></i> Entrar
                    </button>
                </div>
                
                <div id="adminPanel" class="admin-panel">
                    <div class="admin-logout">
                        <button id="adminLogoutBtn" class="export-btn danger">
                            <i class="fas fa-sign-out-alt"></i> Sair
                        </button>
                    </div>
                    
                    <h2><i class="fas fa-cogs"></i> Painel Administrativo</h2>
                    
                    <div class="admin-tabs">
                        <div class="admin-tab active" data-admin-tab="upload">Upload de Dados</div>
                        <div class="admin-tab" data-admin-tab="backup">Backup & Restaura√ß√£o</div>
                    </div>
                    
                    <div class="admin-tab-content active" id="adminUpload">
                        <h3>Upload de Arquivos CSV</h3>
                        <p>Fa√ßa upload de arquivos CSV contendo dados das unidades para atualizar o sistema.</p>
                        
                        <div class="month-selector">
                            <label for="uploadMonth">M√™s de refer√™ncia:</label>
                            <input type="month" id="uploadMonth" required>
                        </div>
                        
                        <div class="upload-area" id="csvUploadArea">
                            <i class="fas fa-file-csv"></i>
                            <h4>Arraste e solte o arquivo CSV da unidade aqui</h4>
                            <p>ou clique para selecionar</p>
                            <input type="file" id="csvFileInput" accept=".csv" style="display: none;">
                        </div>
                        
                        <div class="controls">
                            <button id="processCsvBtn" class="export-btn">
                                <i class="fas fa-cogs"></i> Processar CSV
                            </button>
                            <button id="downloadTemplateBtn" class="export-btn warning">
                                <i class="fas fa-download"></i> Baixar Modelo
                            </button>
                        </div>
                        
                        <div id="csvPreview" class="csv-preview" style="display: none;">
                            <h4>Pr√©via dos Dados</h4>
                            <div id="csvPreviewTable"></div>
                        </div>
                    </div>
                    
                    <div class="admin-tab-content" id="adminBackup">
                        <h3>Backup e Restaura√ß√£o de Dados</h3>
                        <p>Fa√ßa backup de todos os dados do sistema ou restaure a partir de um backup anterior.</p>
                        
                        <div class="controls">
                            <button id="exportBackupBtn" class="export-btn">
                                <i class="fas fa-download"></i> Exportar Backup
                            </button>
                            <button id="importBackupBtn" class="export-btn warning">
                                <i class="fas fa-upload"></i> Importar Backup
                            </button>
                            <input type="file" id="backupFileInput" accept=".json" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- GERENCIAR UNIDADES (VIS√çVEL APENAS PARA ADMIN) -->
            <div class="tab-content" id="manage-units">
                <h2><i class="fas fa-hospital-user"></i> Gerenciar Unidades</h2>
                <p class="data-label" style="margin-bottom: 1.5rem;">Visualize e gerencie todas as unidades de sa√∫de cadastradas no sistema</p>
                
                <div class="unit-manager-header">
                    <h3>Todas as Unidades Cadastradas</h3>
                    <button class="export-btn" id="addUnitBtn">
                        <i class="fas fa-plus"></i> Adicionar Unidade
                    </button>
                </div>
                
                <div class="month-selector">
                    <label for="monthFilterManage">M√™s de refer√™ncia:</label>
                    <select id="monthFilterManage">
                        <!-- Op√ß√µes de m√™s ser√£o preenchidas via JavaScript -->
                    </select>
                </div>
                
                <div id="manageUnitsEmptyState" class="empty-state">
                    <i class="fas fa-hospital-user"></i>
                    <h3>Nenhuma unidade cadastrada</h3>
                    <p>Fa√ßa upload de arquivos CSV na aba Administra√ß√£o para adicionar unidades.</p>
                </div>
                
                <div id="unitsGrid" style="display: none;">
                    <!-- Unidades ser√£o preenchidas via JavaScript -->
                </div>
                
                <div class="table-container" style="margin-top: 2rem; display: none;" id="allUnitsTableContainer">
                    <h3>Resumo de Todas as Unidades</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Unidade</th>
                                <th>Tipo</th>
                                <th>Produtos</th>
                                <th>Status</th>
                                <th>Sugest√µes</th>
                                <th>√öltima Atualiza√ß√£o</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="allUnitsTable">
                            <!-- Dados preenchidos via JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Secretaria Municipal de Sa√∫de &copy; 2025 - Sistema de Controle de Materiais de Limpeza</p>
            <p>Painel de Monitoramento Completo - Dados em Tempo Real</p>
        </footer>
    </div>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCFeYDNbXWNXSBPedaOXfSnDmlLh8Xtn9I",
            authDomain: "materiais-aeb0e.firebaseapp.com",
            projectId: "materiais-aeb0e",
            storageBucket: "materiais-aeb0e.firebasestorage.app",
            messagingSenderId: "78482972694",
            appId: "1:78482972694:web:659039bd4f6ba8689e1537",
            measurementId: "G-70BPGLZ63L"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Estrutura de dados principal - INICIALMENTE VAZIA
        let appData = {
            unidades: [],
            meses: {},
            currentMonth: new Date().toISOString().slice(0, 7), // YYYY-MM
            lastUpdate: new Date().toISOString(),
            isAdmin: false
        };

        // Fun√ß√£o para mostrar/ocultar loading - DEFINIDA NO IN√çCIO
        function toggleLoading(show) {
            const loading = document.getElementById('loading');
            const mainContent = document.getElementById('main-content');
            
            if (show) {
                loading.style.display = 'block';
                mainContent.style.display = 'none';
            } else {
                loading.style.display = 'none';
                mainContent.style.display = 'block';
            }
        }

        // Salvar dados no Firebase
        async function saveDataToFirebase() {
            try {
                appData.lastUpdate = new Date().toISOString();
                await db.collection('dashboardData').doc('limpezaData').set(appData);
                console.log('Dados salvos no Firebase com sucesso');
                return true;
            } catch (error) {
                console.error('Erro ao salvar dados no Firebase:', error);
                // Fallback para localStorage
                saveDataToLocalStorage();
                return false;
            }
        }

        // Carregar dados do Firebase
        async function loadDataFromFirebase() {
            try {
                const doc = await db.collection('dashboardData').doc('limpezaData').get();
                if (doc.exists) {
                    const data = doc.data();
                    appData = { ...appData, ...data };
                    
                    // Garantir que a estrutura de meses esteja correta
                    if (!appData.meses) appData.meses = {};
                    
                    // Garantir que todas as unidades tenham dados para o m√™s atual
                    appData.unidades.forEach(unidade => {
                        if (!unidade.meses) unidade.meses = {};
                        if (!unidade.meses[appData.currentMonth]) {
                            unidade.meses[appData.currentMonth] = {
                                produtos: {},
                                sugestoes: [],
                                dataImportacao: new Date().toISOString()
                            };
                        }
                    });
                    
                    console.log('Dados carregados do Firebase:', appData);
                    return true;
                } else {
                    console.log('Nenhum dado encontrado no Firebase, carregando do localStorage');
                    loadDataFromLocalStorage();
                    return false;
                }
            } catch (error) {
                console.error('Erro ao carregar dados do Firebase:', error);
                loadDataFromLocalStorage();
                return false;
            }
        }

        // Fallback para localStorage
        function saveDataToLocalStorage() {
            try {
                localStorage.setItem('limpezaData', JSON.stringify(appData));
                console.log('Dados salvos no localStorage');
            } catch (e) {
                console.error('Erro ao salvar dados no localStorage:', e);
            }
        }

        function loadDataFromLocalStorage() {
            const saved = localStorage.getItem('limpezaData');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    appData = { ...appData, ...parsed };
                    
                    if (!appData.meses) appData.meses = {};
                    
                    appData.unidades.forEach(unidade => {
                        if (!unidade.meses) unidade.meses = {};
                        if (!unidade.meses[appData.currentMonth]) {
                            unidade.meses[appData.currentMonth] = {
                                produtos: {},
                                sugestoes: [],
                                dataImportacao: new Date().toISOString()
                            };
                        }
                    });
                    
                    console.log('Dados carregados do localStorage:', appData);
                } catch (e) {
                    console.error('Erro ao carregar dados do localStorage:', e);
                }
            }
        }

        // Salvar dados (usa Firebase com fallback para localStorage)
        async function saveData() {
            const firebaseSuccess = await saveDataToFirebase();
            if (!firebaseSuccess) {
                console.log('Usando localStorage como fallback');
            }
        }

        // Carregar dados (usa Firebase com fallback para localStorage)
        async function loadData() {
            await loadDataFromFirebase();
        }

        // Exportar backup - MELHORADO com Firebase
        async function exportBackup() {
            try {
                const backupData = {
                    unidades: appData.unidades,
                    meses: appData.meses,
                    currentMonth: appData.currentMonth,
                    lastUpdate: new Date().toISOString(),
                    backupVersion: '1.0'
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `backup_limpeza_${new Date().toISOString().slice(0,10)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                alert('Backup exportado com sucesso!');
            } catch (error) {
                console.error('Erro ao exportar backup:', error);
                alert('Erro ao exportar backup: ' + error.message);
            }
        }

        // Importar backup - MELHORADO com Firebase
        async function importBackup(file) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (!backupData.unidades || !backupData.meses) {
                        throw new Error('Arquivo de backup inv√°lido');
                    }
                    
                    appData = backupData;
                    await saveData();
                    initDashboard();
                    alert('Backup importado com sucesso!');
                } catch (error) {
                    console.error('Erro ao importar backup:', error);
                    alert('Erro ao importar backup: ' + error.message);
                }
            };
            reader.onerror = function() {
                alert('Erro ao ler o arquivo de backup');
            };
            reader.readAsText(file);
        }

        // Processar dados do CSV - MELHORADO
        async function processCSVData(csvContent, unitName, month) {
            const lines = csvContent.split('\n');
            let currentUnit = null;
            
            currentUnit = appData.unidades.find(u => u.nome === unitName);
            if (!currentUnit) {
                currentUnit = {
                    id: Date.now(),
                    nome: unitName,
                    tipo: unitName.includes("UBS") ? "UBS" : 
                          unitName.includes("Cais") ? "CAIS" : "DEMAIS",
                    meses: {}
                };
                appData.unidades.push(currentUnit);
            }
            
            if (!currentUnit.meses[month]) {
                currentUnit.meses[month] = {
                    produtos: {},
                    sugestoes: [],
                    dataImportacao: new Date().toISOString()
                };
            }
            
            const monthData = currentUnit.meses[month];
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (/^\d+,/.test(line)) {
                    const parts = line.split(',').map(part => part.trim().replace(/"/g, ''));
                    if (parts.length >= 3) {
                        const productName = parts[1];
                        const quantityAvailable = parseInt(parts[2]) || 0;
                        const minSuggested = parseInt(parts[3]) || 0;
                        
                        let status = "ok";
                        if (quantityAvailable === 0) {
                            status = "danger";
                        } else if (quantityAvailable < minSuggested) {
                            status = "warning";
                        }
                        
                        monthData.produtos[productName] = {
                            current: quantityAvailable,
                            min: minSuggested,
                            status: status
                        };
                    }
                }
                
                if (line.includes('ESPA√áO PARA SUGEST√ïES') || (i > 0 && line.includes('"'))) {
                    const parts = line.split(',').map(part => part.trim().replace(/"/g, ''));
                    if (parts.length > 7 && parts[7]) {
                        const sugestao = parts[7];
                        if (sugestao && !sugestao.includes('ESPA√áO PARA SUGEST√ïES')) {
                            const exists = monthData.sugestoes.some(s => s.texto === sugestao);
                            if (!exists) {
                                monthData.sugestoes.push({
                                    id: monthData.sugestoes.length + 1,
                                    texto: sugestao,
                                    data: new Date().toISOString(),
                                    produto: parts[1] ? parts[1] : 'Geral'
                                });
                            }
                        }
                    }
                }
            }
            
            await saveData();
            return currentUnit;
        }

        // Obter dados consolidados para um m√™s espec√≠fico
        function getMonthData(month) {
            const unidadesDoMes = appData.unidades.filter(u => u.meses[month]);
            
            const produtosConsolidados = {};
            const sugestoesConsolidadas = [];
            
            unidadesDoMes.forEach(unidade => {
                const mesData = unidade.meses[month];
                
                Object.entries(mesData.produtos).forEach(([productName, productData]) => {
                    if (!produtosConsolidados[productName]) {
                        produtosConsolidados[productName] = {
                            current: 0,
                            min: 0,
                            unidades: []
                        };
                    }
                    
                    produtosConsolidados[productName].current += productData.current;
                    produtosConsolidados[productName].min += productData.min;
                    produtosConsolidados[productName].unidades.push({
                        unidade: unidade.nome,
                        ...productData
                    });
                });
                
                sugestoesConsolidadas.push(...mesData.sugestoes.map(s => ({
                    ...s,
                    unidade: unidade.nome
                })));
            });
            
            return {
                unidades: unidadesDoMes,
                produtos: produtosConsolidados,
                sugestoes: sugestoesConsolidadas
            };
        }

        // Atualizar seletor de meses
        function updateMonthSelectors() {
            const monthSelectors = [
                'monthFilterOverview', 'monthFilterEfficiency', 'monthFilterUnits',
                'monthFilterProducts', 'monthFilterSuggestions', 'monthFilterAnalysis',
                'monthFilterManage'
            ];
            
            const availableMonths = new Set();
            appData.unidades.forEach(unidade => {
                Object.keys(unidade.meses).forEach(month => {
                    availableMonths.add(month);
                });
            });
            
            const sortedMonths = Array.from(availableMonths).sort().reverse();
            
            monthSelectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector) {
                    selector.innerHTML = '';
                    
                    sortedMonths.forEach(month => {
                        const option = document.createElement('option');
                        option.value = month;
                        option.textContent = formatMonth(month);
                        if (month === appData.currentMonth) {
                            option.selected = true;
                        }
                        selector.appendChild(option);
                    });
                    
                    if (sortedMonths.length === 0) {
                        const option = document.createElement('option');
                        option.value = appData.currentMonth;
                        option.textContent = formatMonth(appData.currentMonth);
                        option.selected = true;
                        selector.appendChild(option);
                    }
                }
            });
        }

        // Formatar m√™s para exibi√ß√£o (YYYY-MM -> MMM/YYYY)
        function formatMonth(monthStr) {
            const [year, month] = monthStr.split('-');
            const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            return `${monthNames[parseInt(month) - 1]}/${year}`;
        }

        // Verificar se h√° dados para exibir
        function hasData() {
            return appData.unidades.length > 0;
        }

        // Atualizar visibilidade dos estados vazios
        function updateEmptyStates() {
            const hasDataFlag = hasData();
            
            const overviewEmptyState = document.getElementById('overviewEmptyState');
            const overviewContent = document.getElementById('overviewContent');
            const efficiencyEmptyState = document.getElementById('efficiencyEmptyState');
            const efficiencyContent = document.getElementById('efficiencyContent');
            const unitsEmptyState = document.getElementById('unitsEmptyState');
            const unitsListContainer = document.getElementById('unitsListContainer');
            const productsEmptyState = document.getElementById('productsEmptyState');
            const productsContent = document.getElementById('productsContent');
            const suggestionsEmptyState = document.getElementById('suggestionsEmptyState');
            const suggestionsContent = document.getElementById('suggestionsContent');
            const analysisEmptyState = document.getElementById('analysisEmptyState');
            const analysisContent = document.getElementById('analysisContent');
            const manageUnitsEmptyState = document.getElementById('manageUnitsEmptyState');
            const unitsGrid = document.getElementById('unitsGrid');
            const allUnitsTableContainer = document.getElementById('allUnitsTableContainer');
            
            if (overviewEmptyState) overviewEmptyState.style.display = hasDataFlag ? 'none' : 'block';
            if (overviewContent) overviewContent.style.display = hasDataFlag ? 'block' : 'none';
            if (efficiencyEmptyState) efficiencyEmptyState.style.display = hasDataFlag ? 'none' : 'block';
            if (efficiencyContent) efficiencyContent.style.display = hasDataFlag ? 'block' : 'none';
            if (unitsEmptyState) unitsEmptyState.style.display = hasDataFlag ? 'none' : 'block';
            if (unitsListContainer) unitsListContainer.style.display = hasDataFlag ? 'block' : 'none';
            if (productsEmptyState) productsEmptyState.style.display = hasDataFlag ? 'none' : 'block';
            if (productsContent) productsContent.style.display = hasDataFlag ? 'block' : 'none';
            if (suggestionsEmptyState) suggestionsEmptyState.style.display = hasDataFlag ? 'none' : 'block';
            if (suggestionsContent) suggestionsContent.style.display = hasDataFlag ? 'block' : 'none';
            if (analysisEmptyState) analysisEmptyState.style.display = hasDataFlag ? 'none' : 'block';
            if (analysisContent) analysisContent.style.display = hasDataFlag ? 'block' : 'none';
            if (manageUnitsEmptyState) manageUnitsEmptyState.style.display = hasDataFlag ? 'none' : 'block';
            if (unitsGrid) unitsGrid.style.display = hasDataFlag ? 'grid' : 'none';
            if (allUnitsTableContainer) allUnitsTableContainer.style.display = hasDataFlag ? 'block' : 'none';
        }

        // Atualizar visibilidade da aba de gerenciamento de unidades
        function updateManageUnitsTabVisibility() {
            const manageUnitsTab = document.querySelector('.tab[data-tab="manage-units"]');
            if (manageUnitsTab) {
                if (appData.isAdmin) {
                    manageUnitsTab.style.display = 'block';
                } else {
                    manageUnitsTab.style.display = 'none';
                    
                    const activeTab = document.querySelector('.tab.active');
                    if (activeTab && activeTab.dataset.tab === 'manage-units') {
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        
                        const overviewTab = document.querySelector('.tab[data-tab="overview"]');
                        const overviewContent = document.getElementById('overview');
                        if (overviewTab && overviewContent) {
                            overviewTab.classList.add('active');
                            overviewContent.classList.add('active');
                        }
                    }
                }
            }
        }

        // Inicializar o dashboard
        async function initDashboard() {
            toggleLoading(true);
            
            try {
                await loadData();
                updateMonthSelectors();
                setupEventListeners();
                updateEmptyStates();
                updateManageUnitsTabVisibility();
                
                if (hasData()) {
                    updateDashboard();
                }
                
                toggleLoading(false);
            } catch (error) {
                console.error('Erro ao inicializar dashboard:', error);
                toggleLoading(false);
            }
        }

        // Atualizar todo o dashboard com os dados atuais
        function updateDashboard() {
            if (!hasData()) {
                updateEmptyStates();
                return;
            }
            
            const currentMonth = document.getElementById('monthFilterOverview').value;
            const monthData = getMonthData(currentMonth);
            
            updateStats(monthData);
            renderCharts(monthData);
            renderUnitsList(monthData);
            renderProductsTable(monthData);
            renderSummaryTable(monthData);
            renderEfficiencyData(monthData);
            renderSuggestions(monthData);
            renderUnitsGrid(monthData);
            generateAIInsights(monthData);
        }

        // Atualizar estat√≠sticas gerais
        function updateStats(monthData) {
            const totalUnitsCount = document.getElementById('totalUnitsCount');
            const totalProductsCount = document.getElementById('totalProductsCount');
            const criticalAlerts = document.getElementById('criticalAlerts');
            const suggestionsCount = document.getElementById('suggestionsCount');
            
            if (totalUnitsCount) totalUnitsCount.textContent = monthData.unidades.length;
            if (totalProductsCount) totalProductsCount.textContent = Object.keys(monthData.produtos).length;
            
            let criticalCount = 0;
            monthData.unidades.forEach(unidade => {
                const mesData = unidade.meses[document.getElementById('monthFilterOverview').value];
                Object.values(mesData.produtos).forEach(product => {
                    if (product.status === "danger") criticalCount++;
                });
            });
            
            if (criticalAlerts) criticalAlerts.textContent = criticalCount;
            if (suggestionsCount) suggestionsCount.textContent = monthData.sugestoes.length;
        }

        // Renderizar gr√°ficos - IMPLEMENTADO
        function renderCharts(monthData) {
            // Gr√°fico 1: Status do Estoque por Unidade
            const statusCtx = document.getElementById('statusChart');
            if (statusCtx) {
                const ctx = statusCtx.getContext('2d');
                
                let okCount = 0, warningCount = 0, dangerCount = 0;
                
                monthData.unidades.forEach(unidade => {
                    const mesData = unidade.meses[document.getElementById('monthFilterOverview').value];
                    let hasDanger = false, hasWarning = false;
                    
                    Object.values(mesData.produtos).forEach(product => {
                        if (product.status === "danger") hasDanger = true;
                        else if (product.status === "warning") hasWarning = true;
                    });
                    
                    if (hasDanger) dangerCount++;
                    else if (hasWarning) warningCount++;
                    else okCount++;
                });
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Normal', 'Aten√ß√£o', 'Cr√≠tico'],
                        datasets: [{
                            label: 'Unidades',
                            data: [okCount, warningCount, dangerCount],
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.7)',
                                'rgba(255, 193, 7, 0.7)',
                                'rgba(220, 53, 69, 0.7)'
                            ],
                            borderColor: [
                                'rgb(40, 167, 69)',
                                'rgb(255, 193, 7)',
                                'rgb(220, 53, 69)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Quantidade de Unidades'
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico 2: Produtos Mais Faltantes
            const productsCtx = document.getElementById('productsChart');
            if (productsCtx) {
                const ctx = productsCtx.getContext('2d');
                
                const productCriticalCount = {};
                monthData.unidades.forEach(unidade => {
                    const mesData = unidade.meses[document.getElementById('monthFilterOverview').value];
                    Object.entries(mesData.produtos).forEach(([product, data]) => {
                        if (data.status === "danger") {
                            productCriticalCount[product] = (productCriticalCount[product] || 0) + 1;
                        }
                    });
                });
                
                const sortedProducts = Object.entries(productCriticalCount)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: sortedProducts.map(p => p[0]),
                        datasets: [{
                            label: 'Unidades com Estoque Cr√≠tico',
                            data: sortedProducts.map(p => p[1]),
                            backgroundColor: 'rgba(220, 53, 69, 0.7)',
                            borderColor: 'rgb(220, 53, 69)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Unidades com Estoque Cr√≠tico'
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico 3: Distribui√ß√£o por Tipo de Unidade
            const typeCtx = document.getElementById('typeChart');
            if (typeCtx) {
                const ctx = typeCtx.getContext('2d');
                
                const typeCount = {
                    UBS: 0,
                    CAIS: 0,
                    DEMAIS: 0
                };
                
                monthData.unidades.forEach(unidade => {
                    typeCount[unidade.tipo] = (typeCount[unidade.tipo] || 0) + 1;
                });
                
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['UBS', 'CAIS', 'Demais'],
                        datasets: [{
                            data: [typeCount.UBS, typeCount.CAIS, typeCount.DEMAIS],
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.7)',
                                'rgba(0, 123, 255, 0.7)',
                                'rgba(108, 117, 125, 0.7)'
                            ],
                            borderColor: [
                                'rgb(40, 167, 69)',
                                'rgb(0, 123, 255)',
                                'rgb(108, 117, 125)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Gr√°fico 4: Evolu√ß√£o de Alertas (simplificado)
            const trendCtx = document.getElementById('trendChart');
            if (trendCtx) {
                const ctx = trendCtx.getContext('2d');
                
                // Dados de exemplo para a evolu√ß√£o
                const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun'];
                const criticalData = [5, 7, 3, 8, 6, 4];
                const warningData = [10, 8, 12, 9, 11, 7];
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: 'Alertas Cr√≠ticos',
                                data: criticalData,
                                borderColor: 'rgb(220, 53, 69)',
                                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                tension: 0.3,
                                fill: true
                            },
                            {
                                label: 'Alertas de Aten√ß√£o',
                                data: warningData,
                                borderColor: 'rgb(255, 193, 7)',
                                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                tension: 0.3,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Quantidade de Alertas'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Renderizar lista de unidades
        function renderUnitsList(monthData) {
            const container = document.getElementById('unitsListContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            monthData.unidades.forEach(unidade => {
                const mesData = unidade.meses[document.getElementById('monthFilterUnits').value];
                const criticalCount = Object.values(mesData.produtos).filter(p => p.status === "danger").length;
                const attentionCount = Object.values(mesData.produtos).filter(p => p.status === "warning").length;
                
                const unitElement = document.createElement('div');
                unitElement.className = 'unit-item';
                unitElement.innerHTML = `
                    <div style="font-weight: bold;">${unidade.nome}</div>
                    <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                        <span class="unit-type type-${unidade.tipo.toLowerCase()}">${unidade.tipo}</span>
                        <div>
                            <span class="status danger" style="margin-right: 0.5rem;">${criticalCount} cr√≠tico(s)</span>
                            <span class="status warning">${attentionCount} aten√ß√£o</span>
                        </div>
                    </div>
                `;
                
                unitElement.addEventListener('click', () => showUnitDetails(unidade));
                container.appendChild(unitElement);
            });
        }

        // Mostrar detalhes da unidade selecionada
        function showUnitDetails(unidade) {
            const currentMonth = document.getElementById('monthFilterUnits').value;
            const mesData = unidade.meses[currentMonth];
            
            const selectedUnitName = document.getElementById('selectedUnitName');
            if (selectedUnitName) {
                selectedUnitName.textContent = `${unidade.nome} - ${formatMonth(currentMonth)}`;
            }
            
            const container = document.getElementById('unitProductsGrid');
            if (!container) return;
            
            container.innerHTML = '';
            
            Object.entries(mesData.produtos).forEach(([product, data]) => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                
                productCard.innerHTML = `
                    <div class="product-header">
                        <div class="product-name">${product}</div>
                        <span class="status ${data.status}">${
                            data.status === 'ok' ? 'Normal' : 
                            data.status === 'warning' ? 'Aten√ß√£o' : 'Cr√≠tico'
                        }</span>
                    </div>
                    <div class="product-data">
                        <div class="data-item">
                            <div class="data-label">Quantidade Atual</div>
                            <div class="data-value">${data.current}</div>
                        </div>
                        <div class="data-item">
                            <div class="data-label">M√≠nimo Sugerido</div>
                            <div class="data-value">${data.min}</div>
                        </div>
                    </div>
                `;
                
                container.appendChild(productCard);
            });
            
            // Ativar visualmente a unidade selecionada
            document.querySelectorAll('.unit-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
        }

        // Renderizar tabela de produtos
        function renderProductsTable(monthData) {
            const container = document.getElementById('productsTableBody');
            if (!container) return;
            
            container.innerHTML = '';
            
            const filterProduct = document.getElementById('filterProduct');
            if (filterProduct) {
                // Limpar op√ß√µes existentes (exceto a primeira)
                while (filterProduct.children.length > 1) {
                    filterProduct.removeChild(filterProduct.lastChild);
                }
                
                Object.keys(monthData.produtos).forEach(product => {
                    // Adicionar op√ß√£o ao filtro
                    const option = document.createElement('option');
                    option.value = product;
                    option.textContent = product;
                    filterProduct.appendChild(option);
                    
                    // Calcular estat√≠sticas do produto
                    const productData = monthData.produtos[product];
                    const lowStockUnits = productData.unidades.filter(u => u.status === "warning").length;
                    const criticalUnits = productData.unidades.filter(u => u.status === "danger").length;
                    
                    let status = "ok";
                    if (criticalUnits > 0) status = "danger";
                    else if (lowStockUnits > 0) status = "warning";
                    
                    const row = document.createElement('tr');
                    row.className = 'clickable-row';
                    row.innerHTML = `
                        <td><strong>${product}</strong></td>
                        <td>${productData.current}</td>
                        <td>${productData.min}</td>
                        <td>${lowStockUnits}</td>
                        <td>${criticalUnits}</td>
                        <td><span class="status ${status}">${
                            status === 'ok' ? 'Normal' : 
                            status === 'warning' ? 'Aten√ß√£o' : 'Cr√≠tico'
                        }</span></td>
                    `;
                    
                    // Adicionar evento de clique para mostrar detalhes
                    row.addEventListener('click', () => showProductDetails(product, monthData));
                    container.appendChild(row);
                });
            }
        }

        // Mostrar detalhes do produto
        function showProductDetails(productName, monthData) {
            const productData = monthData.produtos[productName];
            
            // Mostrar painel de detalhes
            const panel = document.getElementById('productDetailPanel');
            if (panel) {
                panel.classList.add('active');
                
                // Atualizar t√≠tulo
                const selectedProductName = document.getElementById('selectedProductName');
                if (selectedProductName) {
                    selectedProductName.textContent = productName;
                }
                
                // Calcular estat√≠sticas detalhadas
                const lowStockCount = productData.unidades.filter(u => u.status === "warning").length;
                const criticalStockCount = productData.unidades.filter(u => u.status === "danger").length;
                
                // Atualizar estat√≠sticas
                const detailTotalStock = document.getElementById('detailTotalStock');
                const detailTotalMin = document.getElementById('detailTotalMin');
                const detailLowStock = document.getElementById('detailLowStock');
                const detailCriticalStock = document.getElementById('detailCriticalStock');
                
                if (detailTotalStock) detailTotalStock.textContent = productData.current;
                if (detailTotalMin) detailTotalMin.textContent = productData.min;
                if (detailLowStock) detailLowStock.textContent = lowStockCount;
                if (detailCriticalStock) detailCriticalStock.textContent = criticalStockCount;
                
                // Renderizar lista de unidades
                renderUnitsDistribution(productData.unidades);
                
                // Rolagem suave para o painel
                panel.scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Renderizar distribui√ß√£o por unidades
        function renderUnitsDistribution(unitsWithProduct) {
            const container = document.getElementById('unitsDistribution');
            if (!container) return;
            
            container.innerHTML = '';
            
            // Ordenar unidades por quantidade (maior para menor)
            const sortedUnits = [...unitsWithProduct].sort((a, b) => b.current - a.current);
            
            sortedUnits.forEach(item => {
                const percentage = (item.current / item.min) * 100;
                let fillClass = 'ok';
                if (percentage < 70) fillClass = 'danger';
                else if (percentage < 100) fillClass = 'warning';
                
                const distributionItem = document.createElement('div');
                distributionItem.className = 'unit-distribution-item';
                distributionItem.innerHTML = `
                    <div class="unit-distribution-info">
                        <div><strong>${item.unidade}</strong></div>
                        <div style="font-size: 0.8rem; color: var(--gray);">
                            ${item.current} de ${item.min} unidades
                        </div>
                    </div>
                    <div class="unit-distribution-stock">
                        <div class="stock-bar">
                            <div class="stock-fill ${fillClass}" style="width: ${Math.min(percentage, 100)}%"></div>
                        </div>
                        <span class="status ${item.status}">${
                            item.status === 'ok' ? 'Normal' : 
                            item.status === 'warning' ? 'Aten√ß√£o' : 'Cr√≠tico'
                        }</span>
                    </div>
                `;
                
                container.appendChild(distributionItem);
            });
        }

        // Renderizar tabela resumo
        function renderSummaryTable(monthData) {
            const container = document.getElementById('summaryTableBody');
            if (!container) return;
            
            container.innerHTML = '';
            
            monthData.unidades.forEach(unidade => {
                const mesData = unidade.meses[document.getElementById('monthFilterOverview').value];
                const criticalCount = Object.values(mesData.produtos).filter(p => p.status === "danger").length;
                const attentionCount = Object.values(mesData.produtos).filter(p => p.status === "warning").length;
                
                let status = "ok";
                if (criticalCount > 0) status = "danger";
                else if (attentionCount > 0) status = "warning";
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${unidade.nome}</td>
                    <td><span class="unit-type type-${unidade.tipo.toLowerCase()}">${unidade.tipo}</span></td>
                    <td>${criticalCount}</td>
                    <td>${attentionCount}</td>
                    <td>${mesData.sugestoes.length}</td>
                    <td><span class="status ${status}">${
                        status === 'ok' ? 'Normal' : 
                        status === 'warning' ? 'Aten√ß√£o' : 'Cr√≠tico'
                    }</span></td>
                    <td>${new Date(mesData.dataImportacao).toLocaleDateString('pt-BR')}</td>
                `;
                
                container.appendChild(row);
            });
        }

        // Renderizar dados de efici√™ncia - MELHORADO
        function renderEfficiencyData(monthData) {
            // Calcular efici√™ncia para cada unidade
            monthData.unidades.forEach(unidade => {
                const mesData = unidade.meses[document.getElementById('monthFilterEfficiency').value];
                let efficiencyScore = 0;
                let productsAnalyzed = 0;
                
                Object.values(mesData.produtos).forEach(product => {
                    if (product.min > 0) {
                        const efficiency = Math.min(100, (product.current / product.min) * 100);
                        efficiencyScore += efficiency;
                        productsAnalyzed++;
                    }
                });
                
                unidade.efficiency = productsAnalyzed > 0 ? efficiencyScore / productsAnalyzed : 0;
            });
            
            // Atualizar estat√≠sticas de efici√™ncia
            const efficientUnits = document.getElementById('efficientUnits');
            const attentionUnits = document.getElementById('attentionUnits');
            const criticalUnits = document.getElementById('criticalUnits');
            
            if (efficientUnits && attentionUnits && criticalUnits) {
                const efficientCount = monthData.unidades.filter(u => u.efficiency >= 90).length;
                const attentionCount = monthData.unidades.filter(u => u.efficiency >= 70 && u.efficiency < 90).length;
                const criticalCount = monthData.unidades.filter(u => u.efficiency < 70).length;
                
                efficientUnits.textContent = efficientCount;
                attentionUnits.textContent = attentionCount;
                criticalUnits.textContent = criticalCount;
            }
            
            // Renderizar gr√°ficos de efici√™ncia
            renderEfficiencyCharts(monthData);
            
            // Renderizar tabela de efici√™ncia
            const container = document.getElementById('efficiencyTableBody');
            if (container) {
                container.innerHTML = '';
                
                const sortedByEfficiency = [...monthData.unidades].sort((a, b) => b.efficiency - a.efficiency);
                
                sortedByEfficiency.forEach((unidade, index) => {
                    let efficiencyClass = 'efficiency-high';
                    if (unidade.efficiency < 90) efficiencyClass = 'efficiency-medium';
                    if (unidade.efficiency < 70) efficiencyClass = 'efficiency-low';
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${unidade.nome}</td>
                        <td><span class="unit-type type-${unidade.tipo.toLowerCase()}">${unidade.tipo}</span></td>
                        <td>${unidade.efficiency.toFixed(1)}%</td>
                        <td><span class="efficiency-badge ${efficiencyClass}">${
                            unidade.efficiency >= 90 ? 'Alta' : 
                            unidade.efficiency >= 70 ? 'M√©dia' : 'Baixa'
                        }</span></td>
                        <td>${Object.keys(unidade.meses[document.getElementById('monthFilterEfficiency').value].produtos).length}</td>
                    `;
                    
                    container.appendChild(row);
                });
            }
        }

        // Renderizar gr√°ficos de efici√™ncia - IMPLEMENTADO
        function renderEfficiencyCharts(monthData) {
            // Gr√°fico 1: Distribui√ß√£o da Efici√™ncia
            const distributionCtx = document.getElementById('efficiencyDistributionChart');
            if (distributionCtx) {
                const ctx = distributionCtx.getContext('2d');
                
                const efficiencyRanges = {
                    alta: monthData.unidades.filter(u => u.efficiency >= 90).length,
                    media: monthData.unidades.filter(u => u.efficiency >= 70 && u.efficiency < 90).length,
                    baixa: monthData.unidades.filter(u => u.efficiency < 70).length
                };
                
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Alta (‚â•90%)', 'M√©dia (70-89%)', 'Baixa (<70%)'],
                        datasets: [{
                            data: [efficiencyRanges.alta, efficiencyRanges.media, efficiencyRanges.baixa],
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.7)',
                                'rgba(255, 193, 7, 0.7)',
                                'rgba(220, 53, 69, 0.7)'
                            ],
                            borderColor: [
                                'rgb(40, 167, 69)',
                                'rgb(255, 193, 7)',
                                'rgb(220, 53, 69)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Gr√°fico 2: Unidades Mais Eficientes (top 10)
            const topCtx = document.getElementById('topEfficiencyChart');
            if (topCtx) {
                const ctx = topCtx.getContext('2d');
                
                const topUnits = [...monthData.unidades]
                    .sort((a, b) => b.efficiency - a.efficiency)
                    .slice(0, 10);
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: topUnits.map(u => u.nome),
                        datasets: [{
                            label: 'Efici√™ncia (%)',
                            data: topUnits.map(u => u.efficiency),
                            backgroundColor: 'rgba(40, 167, 69, 0.7)',
                            borderColor: 'rgb(40, 167, 69)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Efici√™ncia (%)'
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico 3: Unidades Menos Eficientes (bottom 10)
            const bottomCtx = document.getElementById('bottomEfficiencyChart');
            if (bottomCtx) {
                const ctx = bottomCtx.getContext('2d');
                
                const bottomUnits = [...monthData.unidades]
                    .sort((a, b) => a.efficiency - b.efficiency)
                    .slice(0, 10);
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: bottomUnits.map(u => u.nome),
                        datasets: [{
                            label: 'Efici√™ncia (%)',
                            data: bottomUnits.map(u => u.efficiency),
                            backgroundColor: 'rgba(220, 53, 69, 0.7)',
                            borderColor: 'rgb(220, 53, 69)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Efici√™ncia (%)'
                                }
                            }
                        }
                    }
                });
            }
            
            // Gr√°fico 4: Efici√™ncia M√©dia por Tipo de Unidade
            const typeCtx = document.getElementById('efficiencyByTypeChart');
            if (typeCtx) {
                const ctx = typeCtx.getContext('2d');
                
                const typeEfficiency = {
                    UBS: 0,
                    CAIS: 0,
                    DEMAIS: 0
                };
                const typeCount = {
                    UBS: 0,
                    CAIS: 0,
                    DEMAIS: 0
                };
                
                monthData.unidades.forEach(unidade => {
                    typeEfficiency[unidade.tipo] += unidade.efficiency;
                    typeCount[unidade.tipo]++;
                });
                
                Object.keys(typeEfficiency).forEach(type => {
                    if (typeCount[type] > 0) {
                        typeEfficiency[type] = typeEfficiency[type] / typeCount[type];
                    }
                });
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['UBS', 'CAIS', 'Demais'],
                        datasets: [{
                            label: 'Efici√™ncia M√©dia (%)',
                            data: [typeEfficiency.UBS, typeEfficiency.CAIS, typeEfficiency.DEMAIS],
                            backgroundColor: [
                                'rgba(40, 167, 69, 0.7)',
                                'rgba(0, 123, 255, 0.7)',
                                'rgba(108, 117, 125, 0.7)'
                            ],
                            borderColor: [
                                'rgb(40, 167, 69)',
                                'rgb(0, 123, 255)',
                                'rgb(108, 117, 125)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Efici√™ncia M√©dia (%)'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Renderizar sugest√µes - MELHORADO
        function renderSuggestions(monthData) {
            const suggestionsContainer = document.getElementById('suggestionsList');
            if (suggestionsContainer) {
                suggestionsContainer.innerHTML = '';
                
                if (monthData.sugestoes.length === 0) {
                    suggestionsContainer.innerHTML = '<p>Nenhuma sugest√£o encontrada para este m√™s.</p>';
                } else {
                    monthData.sugestoes.forEach(sugestao => {
                        const suggestionElement = document.createElement('div');
                        suggestionElement.className = 'suggestion-full-item';
                        suggestionElement.innerHTML = `
                            <div class="suggestion-meta">
                                <strong>${sugestao.unidade}</strong>
                                <span class="suggestion-date">${new Date(sugestao.data).toLocaleDateString('pt-BR')}</span>
                            </div>
                            <div class="suggestion-content">
                                <p><strong>Produto:</strong> ${sugestao.produto}</p>
                                <p>${sugestao.texto}</p>
                            </div>
                        `;
                        suggestionsContainer.appendChild(suggestionElement);
                    });
                }
            }
            
            const respondentDetails = document.getElementById('respondentDetails');
            if (respondentDetails) {
                respondentDetails.innerHTML = '<p>Selecione uma sugest√£o para ver detalhes do respondente.</p>';
            }
            
            const supplierIssuesContainer = document.getElementById('supplierIssuesList');
            if (supplierIssuesContainer) {
                const supplierIssues = monthData.sugestoes.filter(s => 
                    s.texto.toLowerCase().includes('fornecedor') || 
                    s.texto.toLowerCase().includes('entrega') ||
                    s.texto.toLowerCase().includes('pedido') ||
                    s.texto.toLowerCase().includes('enviado') ||
                    s.texto.toLowerCase().includes('qualidade')
                );
                
                if (supplierIssues.length === 0) {
                    supplierIssuesContainer.innerHTML = '<p>Nenhum problema espec√≠fico com fornecedor identificado nas sugest√µes deste m√™s.</p>';
                } else {
                    supplierIssuesContainer.innerHTML = '';
                    supplierIssues.forEach(issue => {
                        const issueElement = document.createElement('div');
                        issueElement.className = 'issue-item';
                        issueElement.innerHTML = `
                            <h4>${issue.unidade} - ${issue.produto}</h4>
                            <p>${issue.texto}</p>
                            <div style="display: flex; justify-content: space-between; margin-top: 0.5rem;">
                                <span>${issue.unidade}</span>
                                <span class="suggestion-date">${new Date(issue.data).toLocaleDateString('pt-BR')}</span>
                            </div>
                        `;
                        supplierIssuesContainer.appendChild(issueElement);
                    });
                }
            }
        }

        // Renderizar grid de unidades
        function renderUnitsGrid(monthData) {
            const container = document.getElementById('unitsGrid');
            if (container) {
                container.innerHTML = '';
                
                monthData.unidades.forEach(unidade => {
                    const mesData = unidade.meses[document.getElementById('monthFilterManage').value];
                    const criticalCount = Object.values(mesData.produtos).filter(p => p.status === "danger").length;
                    const attentionCount = Object.values(mesData.produtos).filter(p => p.status === "warning").length;
                    
                    let status = "ok";
                    if (criticalCount > 0) status = "danger";
                    else if (attentionCount > 0) status = "warning";
                    
                    const unitCard = document.createElement('div');
                    unitCard.className = 'unit-manager-card';
                    unitCard.innerHTML = `
                        <div class="unit-manager-card-header">
                            <h4>${unidade.nome}</h4>
                            <span class="unit-type type-${unidade.tipo.toLowerCase()}">${unidade.tipo}</span>
                        </div>
                        <div class="product-data">
                            <div class="data-item">
                                <div class="data-label">Produtos Cadastrados</div>
                                <div class="data-value">${Object.keys(mesData.produtos).length}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Status Geral</div>
                                <div class="data-value"><span class="status ${status}">${
                                    status === 'ok' ? 'Normal' : 
                                    status === 'warning' ? 'Aten√ß√£o' : 'Cr√≠tico'
                                }</span></div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Sugest√µes</div>
                                <div class="data-value">${mesData.sugestoes.length}</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">√öltima Atualiza√ß√£o</div>
                                <div class="data-value">${new Date(mesData.dataImportacao).toLocaleDateString('pt-BR')}</div>
                            </div>
                        </div>
                        <div class="unit-manager-actions" style="margin-top: 1rem;">
                            <button class="export-btn unit-manager-btn" onclick="viewUnitDetails('${unidade.id}')">
                                <i class="fas fa-eye"></i> Ver
                            </button>
                            <button class="export-btn warning unit-manager-btn" onclick="exportUnitData('${unidade.id}')">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                            <button class="export-btn danger unit-manager-btn" onclick="removeUnit('${unidade.id}')">
                                <i class="fas fa-trash"></i> Remover
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(unitCard);
                });
            }
            
            // Atualizar tabela de resumo
            const tableContainer = document.getElementById('allUnitsTable');
            if (tableContainer) {
                tableContainer.innerHTML = '';
                
                monthData.unidades.forEach(unidade => {
                    const mesData = unidade.meses[document.getElementById('monthFilterManage').value];
                    const criticalCount = Object.values(mesData.produtos).filter(p => p.status === "danger").length;
                    const attentionCount = Object.values(mesData.produtos).filter(p => p.status === "warning").length;
                    
                    let status = "ok";
                    if (criticalCount > 0) status = "danger";
                    else if (attentionCount > 0) status = "warning";
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${unidade.nome}</td>
                        <td><span class="unit-type type-${unidade.tipo.toLowerCase()}">${unidade.tipo}</span></td>
                        <td>${Object.keys(mesData.produtos).length}</td>
                        <td><span class="status ${status}">${
                            status === 'ok' ? 'Normal' : 
                            status === 'warning' ? 'Aten√ß√£o' : 'Cr√≠tico'
                        }</span></td>
                        <td>${mesData.sugestoes.length}</td>
                        <td>${new Date(mesData.dataImportacao).toLocaleDateString('pt-BR')}</td>
                        <td>
                            <button class="export-btn unit-manager-btn" onclick="viewUnitDetails('${unidade.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="export-btn danger unit-manager-btn" onclick="removeUnit('${unidade.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    tableContainer.appendChild(row);
                });
            }
        }

        // Gerar insights de IA - MELHORADO
        function generateAIInsights(monthData) {
            // An√°lise de padr√µes de consumo
            let totalStock = 0;
            let totalMin = 0;
            
            monthData.unidades.forEach(unidade => {
                const mesData = unidade.meses[document.getElementById('monthFilterAnalysis').value];
                Object.values(mesData.produtos).forEach(product => {
                    totalStock += product.current;
                    totalMin += product.min;
                });
            });
            
            const efficiencyRate = (totalStock / totalMin * 100).toFixed(1);
            
            // Produtos mais cr√≠ticos
            const criticalProducts = {};
            monthData.unidades.forEach(unidade => {
                const mesData = unidade.meses[document.getElementById('monthFilterAnalysis').value];
                Object.entries(mesData.produtos).forEach(([product, data]) => {
                    if (data.status === "danger") {
                        criticalProducts[product] = (criticalProducts[product] || 0) + 1;
                    }
                });
            });
            
            const mostCritical = Object.entries(criticalProducts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(p => p[0]);
            
            // Unidades com mais problemas
            const unitProblems = {};
            monthData.unidades.forEach(unidade => {
                const mesData = unidade.meses[document.getElementById('monthFilterAnalysis').value];
                const criticalCount = Object.values(mesData.produtos).filter(p => p.status === "danger").length;
                unitProblems[unidade.nome] = criticalCount;
            });
            
            const mostProblematic = Object.entries(unitProblems)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(p => p[0]);
            
            // Atualizar insights
            const consumptionPatterns = document.getElementById('consumptionPatterns');
            const priorityAlerts = document.getElementById('priorityAlerts');
            const consolidatedSuggestions = document.getElementById('consolidatedSuggestions');
            const trendsPredictions = document.getElementById('trendsPredictions');
            const resourceOptimization = document.getElementById('resourceOptimization');
            
            if (consumptionPatterns) {
                consumptionPatterns.textContent = 
                    `Efici√™ncia geral do estoque: ${efficiencyRate}%. ${monthData.unidades.length} unidade(s) analisada(s).`;
            }
            
            if (priorityAlerts) {
                priorityAlerts.textContent = 
                    mostCritical.length > 0 
                        ? `Produtos mais cr√≠ticos: ${mostCritical.join(', ')}. Unidades com mais problemas: ${mostProblematic.join(', ')}.`
                        : "Nenhum produto em situa√ß√£o cr√≠tica identificado.";
            }
            
            if (consolidatedSuggestions) {
                consolidatedSuggestions.textContent = 
                    monthData.sugestoes.length > 0
                        ? `${monthData.sugestoes.length} sugest√µes recebidas de ${new Set(monthData.sugestoes.map(s => s.unidade)).size} unidades.`
                        : "Nenhuma sugest√£o recebida neste per√≠odo.";
            }
            
            if (trendsPredictions) {
                trendsPredictions.textContent = 
                    `Com base nos dados atuais, recomenda-se revis√£o peri√≥dica a cada 30 dias.`;
            }
            
            if (resourceOptimization) {
                resourceOptimization.textContent = 
                    `Potencial de otimiza√ß√£o identificado: ${(100 - efficiencyRate).toFixed(1)}% dos recursos podem ser melhor alocados.`;
            }
        }

        // Fun√ß√µes administrativas
        async function loginAdmin(username, password) {
            if (username === 'admin' && password === 'ZXqwas123@') {
                try {
                    // Tentar autenticar no Firebase
                    await auth.signInWithEmailAndPassword(username + '@materiais.com', password);
                    appData.isAdmin = true;
                    const adminLogin = document.getElementById('adminLogin');
                    const adminPanel = document.getElementById('adminPanel');
                    if (adminLogin) adminLogin.style.display = 'none';
                    if (adminPanel) adminPanel.style.display = 'block';
                    updateManageUnitsTabVisibility();
                    return true;
                } catch (error) {
                    // Fallback para autentica√ß√£o local
                    console.log('Autentica√ß√£o Firebase falhou, usando fallback local');
                    appData.isAdmin = true;
                    const adminLogin = document.getElementById('adminLogin');
                    const adminPanel = document.getElementById('adminPanel');
                    if (adminLogin) adminLogin.style.display = 'none';
                    if (adminPanel) adminPanel.style.display = 'block';
                    updateManageUnitsTabVisibility();
                    return true;
                }
            } else {
                alert('Usu√°rio ou senha incorretos!');
                return false;
            }
        }

        function logoutAdmin() {
            auth.signOut();
            appData.isAdmin = false;
            const adminLogin = document.getElementById('adminLogin');
            const adminPanel = document.getElementById('adminPanel');
            const adminUsername = document.getElementById('adminUsername');
            const adminPassword = document.getElementById('adminPassword');
            
            if (adminLogin) adminLogin.style.display = 'block';
            if (adminPanel) adminPanel.style.display = 'none';
            if (adminUsername) adminUsername.value = '';
            if (adminPassword) adminPassword.value = '';
            updateManageUnitsTabVisibility();
        }

        function downloadCSVTemplate() {
            const csvContent = "UNIDADE:,Nome da Unidade\nItem,Produto,Quantidade Dispon√≠vel,Quantidade M√≠nima Sugerida,,SUGEST√ÉO DE PRODUTO N√ÉO DISPONIBILIZADO E NECESS√ÅRIO,QUANDIDADE M√çNIMAMENTE SUGERIDA,,ESPA√áO PARA SUGEST√ïES\n1,√ÅGUA SANIT√ÅRIA 5L,10,5,\"\",\"\",\"\",\"\"\n2,√ÅLCOOL IL 70%,8,5,\"\",\"\",\"\",\"\"\n3,AROMATIZADOR AR AGRAD√ÅVEL 400ML,15,10,\"\",\"\",\"\",\"\"";
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'modelo_unidade.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        async function processUploadedCSV(file, month) {
            const reader = new FileReader();
            reader.onload = async function(e) {
                const csvContent = e.target.result;
                const previewTable = document.getElementById('csvPreviewTable');
                const previewContainer = document.getElementById('csvPreview');
                
                // Extrair nome da unidade do CSV
                let unitName = file.name.replace('.csv', '');
                const lines = csvContent.split('\n');
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('UNIDADE:')) {
                        const parts = lines[i].split(',');
                        if (parts.length > 1 && parts[1].trim()) {
                            unitName = parts[1].trim();
                            break;
                        }
                    }
                }
                
                // Mostrar pr√©via dos dados
                const previewLines = csvContent.split('\n').slice(0, 10);
                let tableHTML = '<table style="width: 100%; border-collapse: collapse;">';
                
                previewLines.forEach(line => {
                    tableHTML += '<tr>';
                    line.split(',').forEach(cell => {
                        tableHTML += `<td style="border: 1px solid #ddd; padding: 8px;">${cell}</td>`;
                    });
                    tableHTML += '</tr>';
                });
                
                tableHTML += '</table>';
                if (previewTable) previewTable.innerHTML = tableHTML;
                if (previewContainer) previewContainer.style.display = 'block';
                
                // Processar dados quando o usu√°rio confirmar
                const processCsvBtn = document.getElementById('processCsvBtn');
                if (processCsvBtn) {
                    processCsvBtn.onclick = async function() {
                        toggleLoading(true);
                        try {
                            await processCSVData(csvContent, unitName, month);
                            updateMonthSelectors();
                            updateEmptyStates();
                            updateDashboard();
                            alert(`Dados da unidade "${unitName}" processados com sucesso para o m√™s ${formatMonth(month)}!`);
                            if (previewContainer) previewContainer.style.display = 'none';
                        } catch (error) {
                            console.error('Erro ao processar CSV:', error);
                            alert('Erro ao processar arquivo CSV: ' + error.message);
                        } finally {
                            toggleLoading(false);
                        }
                    };
                }
            };
            reader.readAsText(file);
        }

        // Adicionar nova sugest√£o de produto n√£o disponibilizado
        async function addNewSuggestion(suggestionText) {
            if (!suggestionText.trim()) {
                alert('Por favor, digite uma sugest√£o antes de enviar.');
                return;
            }
            
            // Encontrar a unidade atual (ou criar uma gen√©rica)
            const currentMonth = document.getElementById('monthFilterSuggestions').value;
            let currentUnit = appData.unidades[0]; // Usar a primeira unidade como exemplo
            
            if (!currentUnit) {
                // Se n√£o h√° unidades, criar uma gen√©rica
                currentUnit = {
                    id: Date.now(),
                    nome: 'Sugest√£o Geral',
                    tipo: 'DEMAIS',
                    meses: {}
                };
                appData.unidades.push(currentUnit);
            }
            
            // Inicializar dados do m√™s se necess√°rio
            if (!currentUnit.meses[currentMonth]) {
                currentUnit.meses[currentMonth] = {
                    produtos: {},
                    sugestoes: [],
                    dataImportacao: new Date().toISOString()
                };
            }
            
            // Adicionar a sugest√£o
            currentUnit.meses[currentMonth].sugestoes.push({
                id: currentUnit.meses[currentMonth].sugestoes.length + 1,
                texto: suggestionText,
                data: new Date().toISOString(),
                produto: 'SUGEST√ÉO DE PRODUTO N√ÉO DISPONIBILIZADO E NECESS√ÅRIO'
            });
            
            await saveData();
            updateDashboard();
            const newSuggestion = document.getElementById('newSuggestion');
            if (newSuggestion) newSuggestion.value = '';
            alert('Sugest√£o enviada com sucesso!');
        }

        // Fun√ß√µes de gerenciamento de unidades
        function viewUnitDetails(unitId) {
            const unidade = appData.unidades.find(u => u.id == unitId);
            if (unidade) {
                // Mudar para a aba de unidades e selecionar esta unidade
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                const unitsTab = document.querySelector('[data-tab="units"]');
                const unitsContent = document.getElementById('units');
                if (unitsTab && unitsContent) {
                    unitsTab.classList.add('active');
                    unitsContent.classList.add('active');
                }
                
                // Selecionar a unidade na lista
                setTimeout(() => {
                    showUnitDetails(unidade);
                }, 100);
            }
        }

        function exportUnitData(unitId) {
            const unidade = appData.unidades.find(u => u.id == unitId);
            if (!unidade) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.text(`Relat√≥rio da Unidade - ${unidade.nome}`, 20, 20);
            doc.text(`Data de gera√ß√£o: ${new Date().toLocaleDateString('pt-BR')}`, 20, 30);
            doc.text(`Tipo: ${unidade.tipo}`, 20, 40);
            
            let yPosition = 60;
            Object.keys(unidade.meses).forEach(month => {
                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.text(`M√™s: ${formatMonth(month)}`, 20, yPosition);
                yPosition += 10;
                
                const mesData = unidade.meses[month];
                doc.text(`Produtos: ${Object.keys(mesData.produtos).length}`, 25, yPosition);
                yPosition += 7;
                doc.text(`Sugest√µes: ${mesData.sugestoes.length}`, 25, yPosition);
                yPosition += 10;
            });
            
            doc.save(`relatorio_${unidade.nome.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`);
            alert(`Relat√≥rio da unidade ${unidade.nome} exportado com sucesso!`);
        }

        async function removeUnit(unitId) {
            if (confirm('Tem certeza que deseja remover esta unidade? Esta a√ß√£o n√£o pode ser desfeita.')) {
                appData.unidades = appData.unidades.filter(u => u.id != unitId);
                await saveData();
                updateEmptyStates();
                updateDashboard();
                alert('Unidade removida com sucesso!');
            }
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Alternar entre abas
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const tabContent = document.getElementById(tab.dataset.tab);
                    if (tabContent) {
                        tabContent.classList.add('active');
                    }
                });
            });
            
            // Alternar entre abas administrativas
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.admin-tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const adminTabContent = document.getElementById(tab.dataset.adminTab);
                    if (adminTabContent) {
                        adminTabContent.classList.add('active');
                    }
                });
            });
            
            // Atualizar dados quando o m√™s for alterado
            document.querySelectorAll('select[id^="monthFilter"]').forEach(select => {
                if (select) {
                    select.addEventListener('change', updateDashboard);
                }
            });
            
            // Bot√£o de atualizar dados
            const refreshDataBtn = document.getElementById('refreshData');
            if (refreshDataBtn) {
                refreshDataBtn.addEventListener('click', () => {
                    toggleLoading(true);
                    setTimeout(() => {
                        updateDashboard();
                        toggleLoading(false);
                        alert('Dados atualizados com sucesso!');
                    }, 1000);
                });
            }
            
            // Bot√£o de atualizar produtos
            const refreshProductsBtn = document.getElementById('refreshProducts');
            if (refreshProductsBtn) {
                refreshProductsBtn.addEventListener('click', () => {
                    const currentMonth = document.getElementById('monthFilterProducts').value;
                    const monthData = getMonthData(currentMonth);
                    renderProductsTable(monthData);
                    alert('Dados de produtos atualizados com sucesso!');
                });
            }
            
            // Filtro por tipo de unidade
            const filterType = document.getElementById('filterType');
            if (filterType) {
                filterType.addEventListener('change', () => {
                    const currentMonth = document.getElementById('monthFilterOverview').value;
                    const monthData = getMonthData(currentMonth);
                    renderSummaryTable(monthData);
                });
            }
            
            // Filtro por produto
            const filterProduct = document.getElementById('filterProduct');
            if (filterProduct) {
                filterProduct.addEventListener('change', (e) => {
                    if (e.target.value !== 'all') {
                        const currentMonth = document.getElementById('monthFilterProducts').value;
                        const monthData = getMonthData(currentMonth);
                        showProductDetails(e.target.value, monthData);
                    }
                });
            }
            
            // Configurar bot√µes de exporta√ß√£o
            const exportOverviewBtn = document.getElementById('exportOverview');
            if (exportOverviewBtn) {
                exportOverviewBtn.addEventListener('click', () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    doc.text("Relat√≥rio de Vis√£o Geral - Materiais de Limpeza", 20, 20);
                    doc.text(`Data de gera√ß√£o: ${new Date().toLocaleDateString('pt-BR')}`, 20, 30);
                    doc.save("relatorio_visao_geral.pdf");
                    alert('Relat√≥rio de Vis√£o Geral exportado com sucesso!');
                });
            }
            
            const exportProductDetailBtn = document.getElementById('exportProductDetail');
            if (exportProductDetailBtn) {
                exportProductDetailBtn.addEventListener('click', () => {
                    alert('Funcionalidade de exporta√ß√£o de detalhes do produto em desenvolvimento.');
                });
            }
            
            // Configurar √°rea administrativa
            const adminLoginBtn = document.getElementById('adminLoginBtn');
            if (adminLoginBtn) {
                adminLoginBtn.addEventListener('click', async () => {
                    const username = document.getElementById('adminUsername').value;
                    const password = document.getElementById('adminPassword').value;
                    await loginAdmin(username, password);
                });
            }
            
            const adminLogoutBtn = document.getElementById('adminLogoutBtn');
            if (adminLogoutBtn) {
                adminLogoutBtn.addEventListener('click', logoutAdmin);
            }
            
            // Upload de CSV
            const csvUploadArea = document.getElementById('csvUploadArea');
            if (csvUploadArea) {
                csvUploadArea.addEventListener('click', () => {
                    const csvFileInput = document.getElementById('csvFileInput');
                    if (csvFileInput) {
                        csvFileInput.click();
                    }
                });
            }
            
            const csvFileInput = document.getElementById('csvFileInput');
            if (csvFileInput) {
                csvFileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        const month = document.getElementById('uploadMonth').value;
                        if (!month) {
                            alert('Por favor, selecione um m√™s de refer√™ncia.');
                            return;
                        }
                        processUploadedCSV(e.target.files[0], month);
                    }
                });
            }
            
            // Download de modelo
            const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
            if (downloadTemplateBtn) {
                downloadTemplateBtn.addEventListener('click', downloadCSVTemplate);
            }
            
            // Backup e restaura√ß√£o
            const exportBackupBtn = document.getElementById('exportBackupBtn');
            if (exportBackupBtn) {
                exportBackupBtn.addEventListener('click', exportBackup);
            }
            
            const importBackupBtn = document.getElementById('importBackupBtn');
            if (importBackupBtn) {
                importBackupBtn.addEventListener('click', () => {
                    const backupFileInput = document.getElementById('backupFileInput');
                    if (backupFileInput) {
                        backupFileInput.click();
                    }
                });
            }
            
            const backupFileInput = document.getElementById('backupFileInput');
            if (backupFileInput) {
                backupFileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        importBackup(e.target.files[0]);
                    }
                });
            }
            
            // Adicionar unidade
            const addUnitBtn = document.getElementById('addUnitBtn');
            if (addUnitBtn) {
                addUnitBtn.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    const adminTab = document.querySelector('[data-tab="admin"]');
                    const adminContent = document.getElementById('admin');
                    if (adminTab && adminContent) {
                        adminTab.classList.add('active');
                        adminContent.classList.add('active');
                    }
                });
            }
            
            // Enviar nova sugest√£o
            const submitSuggestionBtn = document.getElementById('submitSuggestion');
            if (submitSuggestionBtn) {
                submitSuggestionBtn.addEventListener('click', () => {
                    const suggestionText = document.getElementById('newSuggestion').value;
                    addNewSuggestion(suggestionText);
                });
            }
        }

        // Inicializar o dashboard quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
